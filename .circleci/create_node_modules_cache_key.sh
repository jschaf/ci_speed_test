#!/bin/sh

set -o nounset
set -o errexit

# Creates a combined cache_key to use for the CircleCI node_modules cache.
#
# A clean build of node_modules depends on both package-lock.json and the
# contents of each patch in patches/. CircleCI can't use multiple files as a
# cache key, so store the cache key in a single file that we can then reference
# from a save_cache step. See
# https://discuss.circleci.com/t/base-cache-key-on-checksum-of-directory-rather-than-a-single-file/20059/4

patches_hashes="$(find ./patches -type f -print0 | xargs -0 sha1sum | awk '{print $1}' | sort)"
package_lock_hash="$(sha1sum package-lock.json | awk '{ print $1 }')"
all_hashes="${patches_hashes}
${package_lock_hash}"
current_hash="$(echo "${all_hashes}" | sha1sum | awk '{print $1 }')"

echo "Collected hashes from all files in ./patches and from package-lock.json:"
printf '%s\n' "${all_hashes}"
echo
echo "Overall hash: ${current_hash}"
echo "Writing current node_modules cache key to .circleci/node_modules_cache_key."
echo "${current_hash}" > .circleci/node_modules_cache_key
